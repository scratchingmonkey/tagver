name: CI

on:
  push:
    branches: [main, release-*]
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add rustfmt component
        run: rustup component add rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Add clippy component
        run: rustup component add clippy

      - name: Run clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cache cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --workspace

      - name: Test
        run: cargo test --workspace

  test-action:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run MinVer-RS action
        id: minver
        uses: ./

      - name: Validate outputs
        run: |
          set -euo pipefail
          echo "version=${{ steps.minver.outputs.version }}"
          echo "major=${{ steps.minver.outputs.major }}"
          echo "minor=${{ steps.minver.outputs.minor }}"
          echo "patch=${{ steps.minver.outputs.patch }}"
          echo "pre-release=${{ steps.minver.outputs.pre-release }}"
          echo "build-metadata=${{ steps.minver.outputs.build-metadata }}"

          # Required numeric outputs
          [[ -n "${{ steps.minver.outputs.version }}" ]] || { echo "version is empty" >&2; exit 1; }
          [[ "${{ steps.minver.outputs.major }}" =~ ^[0-9]+$ ]] || { echo "major not numeric" >&2; exit 1; }
          [[ "${{ steps.minver.outputs.minor }}" =~ ^[0-9]+$ ]] || { echo "minor not numeric" >&2; exit 1; }
          [[ "${{ steps.minver.outputs.patch }}" =~ ^[0-9]+$ ]] || { echo "patch not numeric" >&2; exit 1; }

          # pre-release and build-metadata may be empty; just ensure they exist
          [[ "${{ steps.minver.outputs.pre-release }}" != '' ]] || echo "pre-release is empty (allowed)"
          [[ "${{ steps.minver.outputs.build-metadata }}" != '' ]] || echo "build-metadata is empty (allowed)"
